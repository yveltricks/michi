{% extends "base.html" %}
{% block title %}Track {{ measurement_type|title }}{% endblock %}

{% block extra_head %}
<style>
  .chart-container {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <h1 class="text-2xl font-bold mb-6">Track {{ measurement_type|title|replace('_', ' ') }}</h1>
    
    <!-- Input Form -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4">Log New {{ measurement_type|title|replace('_', ' ') }}</h2>
        <form id="measurement-form" class="space-y-4">
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700">Value</label>
                    <input type="number" step="0.1" name="value" id="measurement-value" 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                           required>
                </div>
                
                {% if measurement_type == 'weight' %}
                <div class="w-32">
                    <label class="block text-sm font-medium text-gray-700">Unit</label>
                    <select name="unit" id="unit-selector" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="kg">kg</option>
                        <option value="lbs">lbs</option>
                    </select>
                </div>
                {% endif %}
            </div>
            
            <div class="text-sm text-gray-600">
                Valid range: {{ limits.min }}-{{ limits.max }} {{ limits.unit }}
            </div>
            
            <button type="submit" 
                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Log Measurement
            </button>
        </form>
    </div>

    <!-- Chart -->
    <div class="chart-container">
        <canvas id="measurementChart"></canvas>
    </div>

    <!-- History -->
    <div class="bg-white rounded-lg shadow-md">
        <h2 class="text-xl font-semibold p-6 border-b">History</h2>
        {% if logs %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for log in logs %}
                    <tr id="log-row-{{ log.id }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ log.date.strftime('%B %d, %Y %H:%M') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ "%.1f"|format(log.value) }} {{ log.unit }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="deleteMeasurement({{ log.id }})"
                                    class="text-red-600 hover:text-red-900">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-6 text-center text-gray-500">
            No entries yet. Start tracking your {{ measurement_type|title|replace('_', ' ') }} to see your progress here.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Unit conversion functions
const kgToLbs = kg => kg * 2.20462;
const lbsToKg = lbs => lbs / 2.20462;

// Chart initialization
let measurementChart = null;

// Initialize the chart
function initChart(data) {
    const ctx = document.getElementById('measurementChart').getContext('2d');
    
    if (measurementChart) {
        measurementChart.destroy();
    }

    measurementChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: '{{ measurement_type|title|replace("_", " ") }}',
                data: data.values,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Load chart data
function loadChartData() {
    fetch(`/api/measurement-data/{{ measurement_type }}`)
        .then(response => response.json())
        .then(data => {
            initChart(data);
        })
        .catch(error => console.error('Error loading chart data:', error));
}

// Delete measurement
function deleteMeasurement(logId) {
    if (!confirm('Are you sure you want to delete this measurement?')) {
        return;
    }

    fetch(`/delete-measurement/${logId}`, {
        method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`log-row-${logId}`).remove();
            loadChartData();  // Refresh the chart
        } else {
            alert(data.error || 'Error deleting measurement');
        }
    })
    .catch(error => console.error('Error:', error));
}

// Handle form submission
document.getElementById('measurement-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    let value = parseFloat(document.getElementById('measurement-value').value);
    const unitSelector = document.getElementById('unit-selector');
    
    // Convert to kg if needed
    if (unitSelector && unitSelector.value === 'lbs') {
        value = lbsToKg(value);
    }

    fetch(`/measurements/{{ measurement_type }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ value: value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Error logging measurement');
        }
    })
    .catch(error => console.error('Error:', error));
});

// Initialize chart on page load
document.addEventListener('DOMContentLoaded', loadChartData);

// Handle unit conversion if unit selector exists
const unitSelector = document.getElementById('unit-selector');
const valueInput = document.getElementById('measurement-value');

if (unitSelector && valueInput) {
    unitSelector.addEventListener('change', function() {
        if (valueInput.value) {
            const currentValue = parseFloat(valueInput.value);
            if (this.value === 'lbs') {
                valueInput.value = (currentValue * 2.20462).toFixed(1);
            } else {
                valueInput.value = (currentValue / 2.20462).toFixed(1);
            }
        }
    });
}
</script>
{% endblock %}