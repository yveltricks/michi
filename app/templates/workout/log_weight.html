{% extends "base.html" %}
{% block title %}Track Weight{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold mb-2">Track Your Weight</h1>
        <p class="text-gray-600">Monitor your progress with accurate weight tracking</p>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Log Weight Form Section -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Log New Weight</h2>
            <form id="weightForm" class="space-y-4">
                <div>
                    <label for="weight" class="block text-sm font-medium text-gray-700">Weight</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <input type="number" step="0.1" name="weight" id="weight" required
                            class="flex-1 block w-full rounded-l-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                            placeholder="Enter weight">
                        <select name="unit" id="unit" class="rounded-r-md border-l-0 border-gray-300 bg-gray-50 px-3 sm:text-sm">
                            <option value="kg">kg</option>
                            <option value="lbs">lbs</option>
                        </select>
                    </div>
                    <p class="mt-1 text-sm text-gray-500">Valid range: 5-600 kg (11-1322 lbs)</p>
                </div>
                <button type="submit" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Log Weight
                </button>
            </form>
        </div>

        <!-- Graph Section -->
        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Weight Progress</h2>
                <select id="timeRange" class="rounded-md border-gray-300 bg-gray-50 px-3 py-1 sm:text-sm">
                    <option value="3m">Last 3 Months</option>
                    <option value="6m">Last 6 Months</option>
                    <option value="1y">Last Year</option>
                    <option value="all">All Time</option>
                </select>
            </div>
            <div id="weightChart" class="w-full h-[400px]"></div>
        </div>

        <!-- Weight History Table -->
        <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Weight History</h2>
            {% if logs %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weight</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for log in logs %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ log.date.strftime('%B %d, %Y %H:%M') }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ "%.2f"|format(log.value) }} {{ log.unit }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button onclick="deleteWeight({{ log.id }})"
                                    class="text-red-600 hover:text-red-900">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-8">
                <p class="text-gray-500 mb-2">No weight entries yet</p>
                <p class="text-sm text-gray-400">Start tracking your weight to see your progress here</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let weightChart = null;

// Initialize the chart
function initializeChart() {
    const ctx = document.getElementById('weightChart').getContext('2d');
    weightChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Weight',
                data: [],
                borderColor: 'rgb(59, 130, 246)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
}

// Function to update chart data
function updateChartData(timeRange) {
    fetch(`/api/weight-data?range=${timeRange}`)
        .then(response => response.json())
        .then(data => {
            weightChart.data.labels = data.labels;
            weightChart.data.datasets[0].data = data.values;
            weightChart.update();
        });
}

// Handle weight form submission
document.getElementById('weightForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const weight = document.getElementById('weight').value;
    const unit = document.getElementById('unit').value;

    fetch('/workout/log-measurement/weight', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ value: weight, unit: unit })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Error logging weight');
        }
    });
});

// Handle time range changes
document.getElementById('timeRange').addEventListener('change', function(e) {
    updateChartData(e.target.value);
});

// Delete weight entry
function deleteWeight(logId) {
    if (confirm('Are you sure you want to delete this weight entry?')) {
        fetch(`/workout/delete-measurement/${logId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error deleting weight entry');
            }
        });
    }
}

// Initialize everything when the page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    updateChartData('3m'); // Default to 3 months view
});
</script>
{% endblock %}